rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {

    /* ── 공통 함수 ── */
    function signedIn() { return request.auth != null; }
    function isSelf(uid) { return signedIn() && request.auth.uid == uid; }
    function isAdmin() {
      return signedIn() && exists(/databases/$(db)/documents/admins/$(request.auth.uid));
    }
    function isBanned(uid) {
      return signedIn() && exists(/databases/$(db)/documents/banned_users/$(uid));
    }
    function canWrite() { return signedIn() && !isBanned(request.auth.uid); }

    /* ── 유효성(닉) ── */
    function isString(s) { return s is string; }
    function nonEmptyString(s, min, max) {
      return isString(s) && s.size() >= min && s.size() <= max;
    }
    function validNickShown(n) {
      return isString(n) && n.matches('^[가-힣A-Za-z0-9_]{2,16}$');
    }

    /* ── 유효성(영상) ── */
    // 이전: size() <= 3  →  이후: 최소 1개 & 최대 3개  // ★
    function validCats(cats) {
      return cats is list
        && cats.size() >= 1 && cats.size() <= 3   // ★
        && cats.all(c, c is string && c.matches('^[a-z0-9_]{1,32}$'));
    }
    function validUrl(u) {
      return isString(u) && u.matches('^https://.+');
    }

    // 생성 시 유효성
    // 이전: uid/url/cats(+title optional)/(ytid optional==id)
    // 이후: 위 + ytid는 필수, type/ownerName/createdAt/youtubePublishedAt 허용(형식검사)  // ★
    function validVideoCreate(data, id) {
      return
        ("uid" in data) && isSelf(data.uid) &&
        ("url" in data) && validUrl(data.url) &&
        ("cats" in data) && validCats(data.cats) &&
        ("ytid" in data) && data.ytid == id &&                // ★ ytid 필수
        (!("type" in data) || (data.type == "video" || data.type == "shorts")) &&               // ★
        (!("ownerName" in data) || isString(data.ownerName)) &&                                  // ★
        (!("createdAt" in data) || (data.createdAt is timestamp)) &&                              // ★ serverTimestamp 허용
        ("title" in data) && nonEmptyString(data.title, 1, 200) &&
        (!("youtubePublishedAt" in data) || isString(data.youtubePublishedAt));                 // ★
        
    }

    // 업데이트 시 유효성 (기본)
    // 이전: uid 동일 + url/cats(+title/ytid= id)
    // 이후: type/ownerName/createdAt/youtubePublishedAt도 허용(형식검사)  // ★
    function validVideoUpdate(oldData, newData, id) {
      return
        ("uid" in oldData) && ("uid" in newData) && oldData.uid == newData.uid &&
        ("url" in newData) && validUrl(newData.url) &&
        ("cats" in newData) && validCats(newData.cats) &&
        (!("ytid" in newData) || newData.ytid == id) &&
        (!("type" in newData) || (newData.type == "video" || newData.type == "shorts")) &&        // ★
        (!("ownerName" in newData) || isString(newData.ownerName)) &&                             // ★
        (!("createdAt" in newData) || (newData.createdAt is timestamp)) &&                        // ★
        ("title" in newData) && nonEmptyString(newData.title, 1, 200) &&
        (!("youtubePublishedAt" in newData) || isString(newData.youtubePublishedAt));            // ★
        
    }

    // 업데이트 시 유효성 (구문서 소유자(uid) 없음 → 최초 1회 클레임 허용)
    // 이후: 동일하게 확장 필드 허용  // ★
    function validVideoUpdateClaim(newData, id) {
      return
        ("uid" in newData) && isSelf(newData.uid) &&
        ("url" in newData) && validUrl(newData.url) &&
        ("cats" in newData) && validCats(newData.cats) &&
        (!("ytid" in newData) || newData.ytid == id) &&
        (!("type" in newData) || (newData.type == "video" || newData.type == "shorts")) &&        // ★
        (!("ownerName" in newData) || isString(newData.ownerName)) &&                             // ★
        (!("createdAt" in newData) || (newData.createdAt is timestamp)) &&                        // ★
        ("title" in newData) && nonEmptyString(newData.title, 1, 200) &&
        (!("youtubePublishedAt" in newData) || isString(newData.youtubePublishedAt));           // ★
        
    }

    /* ── (1) 프로필 ── */
    match /users/{uid} {
      allow read: if true;
      allow create: if canWrite() && isSelf(uid);
      allow update: if canWrite() && isSelf(uid);
      allow delete: if isAdmin();
    }

    /* ── (2) 닉네임 점유 맵 ── */
    match /nicks/{nickKey} {
      allow read: if true;
      allow create: if canWrite()
                    && ("uid" in request.resource.data) && isSelf(request.resource.data.uid)
                    && ("nick" in request.resource.data) && validNickShown(request.resource.data.nick)
                    && nickKey == lower(request.resource.data.nick)
                    && !exists(/databases/$(db)/documents/nicks/$(nickKey));
      allow delete: if (canWrite() && resource.data.uid == request.auth.uid) || isAdmin();
      allow update: if false;
    }

    /* ── (3) 밴 목록 ── */
    match /banned_users/{uid} {
      allow read: if isSelf(uid) || isAdmin();
      allow write: if isAdmin();
    }

    /* ── (4) 의견함 ── */
    match /messages/{id} {
      allow create: if canWrite();
      allow read, delete: if isAdmin();
    }

    /* ── (5) 영상 ── */
    match /videos/{id} {
      allow read: if true;
      allow create: if canWrite() && validVideoCreate(request.resource.data, id);
      allow update: if
        isAdmin() ||
        (
          canWrite() &&
          (
            (("uid" in resource.data) && isSelf(resource.data.uid) &&
             validVideoUpdate(resource.data, request.resource.data, id))
            ||
            ((!("uid" in resource.data)) && validVideoUpdateClaim(request.resource.data, id))
          )
        );
      allow delete: if isAdmin()
                 || (canWrite() && ("uid" in resource.data) && isSelf(resource.data.uid));
    }

    /* ── (6) 관리자 표식 ── */
    match /admins/{uid} {
      allow read: if isSelf(uid);
      allow write: if false;
    }

    /* ── (7) 로그인 로그(선택) ── */
    match /login_logs/{id} {
      allow read: if isAdmin();
      allow create: if signedIn();
      allow update, delete: if false;
    }
  }
}
